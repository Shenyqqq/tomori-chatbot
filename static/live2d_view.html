<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Live2D Tomori Viewer</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: transparent; }
        #live2d-canvas { position: absolute; width: 100%; height: 100%; left: 0; top: 0; }
    </style>
</head>
<body>
    <canvas id="live2d-canvas"></canvas>
		
	<script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/cubism2.min.js"></script>

    <script>
        // åœ¨å¤–éƒ¨å…ˆå£°æ˜ model
let model = null;

// åŠ è½½ Cubism2 æ¨¡å‹ï¼ˆæ­¤éƒ¨åˆ†ä½ å·²å®Œæˆï¼‰
(async function () {
    const modelPath = "/static/live2d_model/tomori/model.json";
    const app = new PIXI.Application({
        view: document.getElementById('live2d-canvas'),
        autoStart: true,
        resizeTo: window,
        backgroundAlpha: 0,
    });

    model = await PIXI.live2d.Live2DModel.from(modelPath, { cubism2: true });
    app.stage.addChild(model);

    model.scale.set(0.25);
    model.anchor.set(0.5, 0.5);
    model.position.set(window.innerWidth / 2, window.innerHeight / 1.8);

    console.log("âœ… Cubism2 æ¨¡å‹åŠ è½½æˆåŠŸ");

    // è‡ªåŠ¨æ’­æ”¾ä¸€ä¸ªåŠ¨ä½œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
    setTimeout(() => {
        model.motion("thinking02", 0, PIXI.live2d.MotionPriority.FORCE);
    }, 1000);

    // ç»‘å®šç›‘å¬ Live2D æŒ‡ä»¤æµ
    setupLive2DCommandListener();
})();

function setupLive2DCommandListener() {
    window.addEventListener('message', (event) => {
        // å®‰å…¨æç¤ºï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥ event.originï¼Œç¡®ä¿æ¶ˆæ¯æ¥è‡ªå¯ä¿¡çš„æº
        // ä¾‹å¦‚: if (event.origin !== 'http://127.0.0.1:7860') return;

        console.log("[iFrame] æ”¶åˆ°æ¶ˆæ¯:", event.data);
        const commandText = event.data;
        if (!commandText || typeof commandText !== 'string') return;

        try {
            // è§£ææ”¶åˆ°çš„ JSON å­—ç¬¦ä¸²æŒ‡ä»¤
            const command = JSON.parse(commandText);
            console.log("ğŸ¬ [iFrame] æ‰§è¡ŒåŠ¨ä½œ:", command.live2d_motion);
            // è°ƒç”¨æ‚¨å·²æœ‰çš„æŒ‡ä»¤å¤„ç†å‡½æ•°
            handleLive2DMotionCommand(command);
        } catch (e) {
            console.error("âŒ [iFrame] æŒ‡ä»¤ JSON è§£æå¤±è´¥", e, "åŸå§‹å†…å®¹:", commandText);
        }
    }, false);

    console.log("âœ… [iFrame] æŒ‡ä»¤ç›‘å¬å™¨å·²å°±ç»ªï¼Œç­‰å¾…æ¶ˆæ¯...");
}

// âœ… æŒ‡ä»¤å¤„ç†å‡½æ•°ï¼šç”¨äºæ‰§è¡Œ motion æ’­æ”¾
function handleLive2DMotionCommand(command) {
    if (!command || typeof command.live2d_motion === 'undefined') {
        console.warn("âš  æœªæä¾› live2d_motion æŒ‡ä»¤");
        return;
    }

    const motionToPlay = command.live2d_motion;

    if (!model || typeof model.motion !== 'function') {
        console.error("âŒ æ¨¡å‹æœªåŠ è½½æˆ–ä¸æ”¯æŒ motion æ–¹æ³•");
        return;
    }

    console.log(`ğŸ¬ æ‰§è¡ŒåŠ¨ä½œï¼š${motionToPlay}`);
    model.motion(motionToPlay, 0, PIXI.live2d.MotionPriority.FORCE);
}

    </script>
</body>
</html>
